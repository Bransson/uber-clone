{% extends "base.html" %}
{% block title %}Driver Dashboard{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Driver Dashboard</h3>
</div>

<h5>Pending Matches</h5>
<div id="matches">
  {% for m in matches %}
    <div class="card mb-2">
      <div class="card-body d-flex justify-content-between">
        <div>
          <strong>Request #{{ m.request.id }}</strong>
          <div class="small">{{ m.request.pickup_address }} → {{ m.request.dropoff_address }}</div>
          <div class="small text-muted">Distance to pickup: {{ m.distance_to_pickup_km }} km • ETA {{ m.eta_to_pickup_min }} min</div>
        </div>
        <div class="align-self-center">
          <button class="btn btn-success btn-accept" data-match="{{ m.id }}">Accept</button>
          <button class="btn btn-outline-danger btn-reject" data-match="{{ m.id }}">Reject</button>
        </div>
      </div>
    </div>
  {% empty %}
    <p class="text-muted">No matches currently.</p>
  {% endfor %}
</div>

<h5 class="mt-4">Active Rides</h5>
<ul class="list-group mt-2">
  {% for r in active_rides %}
    <li class="list-group-item d-flex justify-content-between">
      <div>
        <strong>#{{ r.id }}</strong> {{ r.pickup_address }} → {{ r.dropoff_address }}
        <div class="small text-muted">Status: {{ r.status }}</div>
      </div>
      <div>
        <a class="btn btn-sm btn-outline-primary" href="{% url 'driver_ride_detail' r.id %}">Open</a>
      </div>
    </li>
  {% empty %}
    <li class="list-group-item text-muted">No active rides.</li>
  {% endfor %}
</ul>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function(){
  document.querySelectorAll(".btn-accept").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      const id = e.target.dataset.match;
      const csrftoken = getCookie("csrftoken");
      const res = await fetch("{% url 'accept_match' 0 %}".replace("/0/","/"+id+"/"), {
        method: "POST",
        headers: {"X-CSRFToken": csrftoken}
      });
      const j = await res.json();
      if (j.ok) location.reload();
      else alert(j.error || "Could not accept.");
    });
  });
  document.querySelectorAll(".btn-reject").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      const id = e.target.dataset.match;
      const csrftoken = getCookie("csrftoken");
      const res = await fetch("{% url 'reject_match' 0 %}".replace("/0/","/"+id+"/"), {
        method: "POST",
        headers: {"X-CSRFToken": csrftoken}
      });
      const j = await res.json();
      if (j.ok) location.reload();
      else alert(j.error || "Could not reject.");
    });
  });
});
</script>
{% endblock %}
